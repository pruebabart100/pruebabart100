<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TPV Bar</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header>
        <div class="mesa-selector">
            <span>Mesa:</span>
            <input type="number" id="numMesa" value="1" min="1">
        </div>
        <div id="estado-conexion">ðŸŸ¢ Online</div>
    </header>

    <section class="tabs">
        <button class="tab-btn btn-bebida active" onclick="filtrarCategoria('bebida')">Bebidas</button>
        <button class="tab-btn btn-comida" onclick="filtrarCategoria('comida')">Comidas</button>
        
        <button onclick="lanzarBateriaDePruebas()" style="background:red; color:white; padding:20px; width:100%; margin-top:20px;">
            ðŸ’£ LANZAR TEST DE CONEXIÃ“N
        </button>
    </section>

    <main id="contenedor-productos" class="grid-productos">
        </main>

    <aside id="ticket-resumen">
        <div id="lista-pedidos"></div>
        
        <div class="resumen-info">
            <span id="contador-items">0 productos</span>
            <span id="total-precio">0.00 â‚¬</span>
        </div>
        <button id="btn-enviar" class="btn-enviar" onclick="enviarComanda()">
            Enviar a Cocina ðŸš€
        </button>
    </aside>

    <script>

        //0 prueba
        function lanzarBateriaDePruebas() {
    const url = "PEGA_AQUÃ_TU_NUEVA_URL_TERMINADA_EN_EXEC"; 
    const mesa = "99";
    
    alert("Iniciando bombardeo de pruebas... Revisa el Excel en 10 segundos.");

    // PRUEBA 1: GET (VÃ­a URL) - La mÃ¡s fiable pero limitada en tamaÃ±o
    // DeberÃ­a salir en Excel como: GET -> FORMULARIO/GET
    const payloadGET = JSON.stringify({prueba: "1_GET_Simple"});
    const urlGet = url + "?datos=" + encodeURIComponent(payloadGET);
    fetch(urlGet, { mode: 'no-cors' }).then(() => console.log("Enviado 1"));

    // PRUEBA 2: POST como JSON Puro (text/plain para engaÃ±ar CORS)
    // DeberÃ­a salir como: POST -> BODY RAW (text/plain)
    setTimeout(() => {
        fetch(url, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ mesa: mesa, prueba: "2_POST_TextPlain" })
        }).then(() => console.log("Enviado 2"));
    }, 1000);

    // PRUEBA 3: POST como Formulario (URLSearchParams)
    // DeberÃ­a salir como: POST -> FORMULARIO/GET (Parametro 'datos')
    setTimeout(() => {
        const formData = new URLSearchParams();
        formData.append('datos', JSON.stringify({ mesa: mesa, prueba: "3_POST_Form" }));
        
        fetch(url, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData
        }).then(() => console.log("Enviado 3"));
    }, 2000);

    // PRUEBA 4: POST JSON EstÃ¡ndar (Suele fallar por CORS, pero probemos)
    setTimeout(() => {
        fetch(url, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mesa: mesa, prueba: "4_POST_JsonStandard" })
        }).then(() => console.log("Enviado 4"));
    }, 3000);
}
        
        // 1. CONFIGURACIÃ“N DE PRODUCTOS
        // AquÃ­ puedes aÃ±adir tus platos fÃ¡cilmente
        const productos = [
            { id: 1, nombre: "CaÃ±a", precio: 1.50, cat: "bebida" },
            { id: 2, nombre: "Doble", precio: 2.50, cat: "bebida" },
            { id: 3, nombre: "Refresco", precio: 2.00, cat: "bebida" },
            { id: 4, nombre: "Vino Copa", precio: 3.00, cat: "bebida" },
            { id: 5, nombre: "CafÃ©", precio: 1.20, cat: "bebida" },
            
            { id: 6, nombre: "Bravas", precio: 4.50, cat: "comida" },
            { id: 7, nombre: "Croquetas (6)", precio: 6.00, cat: "comida" },
            { id: 8, nombre: "Hamburguesa", precio: 9.50, cat: "comida" },
            { id: 9, nombre: "Ensalada", precio: 7.00, cat: "comida" },
            { id: 10, nombre: "Pincho Tortilla", precio: 3.50, cat: "comida" }
        ];

        let carrito = [];

        // 2. FUNCIONES DE INICIO
        window.onload = function() {
            filtrarCategoria('bebida'); // Cargar bebidas por defecto
            actualizarTicket();
        };

        // 3. RENDERIZAR PRODUCTOS
        function filtrarCategoria(categoria) {
            const contenedor = document.getElementById('contenedor-productos');
            contenedor.innerHTML = '';
            
            // Actualizar estilo pestaÃ±as
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.btn-${categoria}`).classList.add('active');

            // Crear botones
            const filtrados = productos.filter(p => p.cat === categoria);
            
            filtrados.forEach(prod => {
                const btn = document.createElement('div');
                btn.className = `card-producto tipo-${prod.cat}`;
                btn.onclick = () => agregarAlCarrito(prod);
                btn.innerHTML = `
                    <span class="prod-nombre">${prod.nombre}</span>
                    <span class="prod-precio">${prod.precio.toFixed(2)}â‚¬</span>
                `;
                contenedor.appendChild(btn);
            });
        }

        // 4. LÃ“GICA DEL CARRITO
        function agregarAlCarrito(producto) {
            // Buscamos si ya existe para sumar cantidad (opcional), 
            // pero para cocina suele ser mejor linea a linea o acumulado.
            // AquÃ­ haremos simple: aÃ±adir objeto al array.
            carrito.push(producto);
            actualizarTicket();
        }

        function eliminarDelCarrito(index) {
            carrito.splice(index, 1);
            actualizarTicket();
        }

        function actualizarTicket() {
            const lista = document.getElementById('lista-pedidos');
            const contador = document.getElementById('contador-items');
            const total = document.getElementById('total-precio');
            const btn = document.getElementById('btn-enviar');

            // Renderizar lista
            lista.innerHTML = '';
            let totalCalc = 0;

            carrito.forEach((item, index) => {
                totalCalc += item.precio;
                lista.innerHTML += `
                    <div class="item-pedido">
                        <span>${item.nombre}</span>
                        <div>
                            <span>${item.precio.toFixed(2)}â‚¬</span>
                            <span class="btn-eliminar" onclick="eliminarDelCarrito(${index})">âœ–</span>
                        </div>
                    </div>
                `;
            });

            // Actualizar resumen
            contador.innerText = `${carrito.length} productos`;
            total.innerText = `${totalCalc.toFixed(2)} â‚¬`;

            // Habilitar/Deshabilitar botÃ³n
            if(carrito.length === 0) {
                btn.disabled = true;
                btn.style.opacity = "0.5";
                btn.innerText = "Selecciona productos";
            } else {
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.innerText = `Enviar a Cocina (${totalCalc.toFixed(2)}â‚¬)`;
            }
        }

        function enviarComanda() {
            const mesa = document.getElementById('numMesa').value;
            
            if(!mesa) { alert("âš ï¸ Por favor indica nÃºmero de mesa"); return; }
            if(carrito.length === 0) { alert("âš ï¸ El carrito estÃ¡ vacÃ­o"); return; }

            const btn = document.getElementById('btn-enviar');
            btn.innerText = "Enviando...";
            btn.disabled = true;
            btn.style.backgroundColor = "#9ca3af"; 

            // 1. TU URL BASE (AsegÃºrate que termina en /exec y NO tiene interrogantes al final)
            // Ejemplo correcto: .../exec
            // Ejemplo incorrecto: .../exec?
            const scriptURL = "https://script.google.com/macros/s/AKfycbzOmI7m6OiimyaGX3iOo0JAP0T33ZWtn_Nd0OCwelva_XVFXNPlz6OjPuMqcj5VWL9a/exec"; 

            // 2. Preparamos el paquete de datos
            const datosAEnviar = {
                mesa: mesa,
                carrito: carrito
            };

            // 3. Convertimos el paquete a texto y lo codificamos para URL (para que los espacios y sÃ­mbolos no rompan nada)
            const payload = encodeURIComponent(JSON.stringify(datosAEnviar));

            // 4. Construimos la URL final con el parÃ¡metro ?datos=...
            const urlFinal = scriptURL + "?datos=" + payload;

            // 5. Enviamos usando GET
            fetch(urlFinal, {
                method: "GET",
                mode: "no-cors" // Seguimos usando no-cors para evitar bloqueo, aunque no podamos leer la respuesta
            })
            .then(() => {
                // Asumimos Ã©xito porque GET en no-cors suele pasar siempre si la URL estÃ¡ bien
                alert(`âœ… Pedido enviado a Mesa ${mesa}`);
                carrito = [];
                actualizarTicket();
            })
            .catch(error => {
                console.error('Error:', error);
                alert("âŒ Error al enviar. IntÃ©ntalo de nuevo.");
            })
            .finally(() => {
                btn.innerText = "Enviar a Cocina ðŸš€";
                btn.style.backgroundColor = "";
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
