<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TPV Bar - v3.1 (Collapsible UI)</title>
    
    <style>
        :root { --primary: #2563eb; --food: #ea580c; --drink: #059669; --bg: #f3f4f6; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background-color: var(--bg); padding-bottom: 250px; } /* ‚ö†Ô∏è MUCHO ESPACIO ABAJO para el scroll */

        /* LOADING */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index: 2000; display:flex; justify-content:center; align-items:center; flex-direction:column; }

        /* HEADER */
        header { background: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .mesa-input { font-size: 1.3rem; width: 60px; text-align: center; padding: 5px; border: 2px solid var(--primary); border-radius: 8px; font-weight: bold; }

        /* TABS */
        .tabs { display: flex; gap: 10px; padding: 10px; }
        .tab { flex: 1; padding: 15px; border: none; border-radius: 8px; color: white; font-weight: bold; font-size: 1rem; opacity: 0.5; cursor: pointer; }
        .tab.active { opacity: 1; transform: scale(1.02); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .bg-drink { background-color: var(--drink); }
        .bg-food { background-color: var(--food); }

        /* GRID */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; }
        .card { background: white; padding: 20px 10px; border-radius: 10px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; border-bottom: 4px solid transparent; }
        .card:active { transform: scale(0.95); background: #e5e7eb; }
        .card.type-bebida { border-bottom-color: var(--drink); }
        .card.type-comida { border-bottom-color: var(--food); }
        .p-name { display: block; font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }

        /* TICKET FLOTANTE MEJORADO */
        .ticket { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: white; 
            border-top-left-radius: 20px; border-top-right-radius: 20px; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2); 
            z-index: 900;
            transition: transform 0.3s ease;
        }

        /* Pesta√±a para minimizar */
        .ticket-header {
            width: 100%; padding: 10px; text-align: center; cursor: pointer;
            background: #f9fafb; border-top-left-radius: 20px; border-top-right-radius: 20px;
            border-bottom: 1px solid #eee; color: #666; font-size: 1.2rem;
        }

        .ticket-content { padding: 15px; }
        
        /* Lista con scroll interno limitado */
        .ticket-list { 
            max-height: 25vh; /* Ocupa m√°ximo el 25% de la pantalla */
            overflow-y: auto; 
            margin-bottom: 10px; 
            font-size: 0.9rem; 
            transition: max-height 0.3s ease;
        }
        
        .ticket-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #ccc; }
        .btn-del { color: red; font-weight: bold; margin-left: 10px; cursor: pointer; padding: 0 10px; }
        
        .resumen-row { display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold; font-size: 1.1rem; }
        
        .btn-send { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        .btn-send:disabled { background: #ccc; }
        
        .version { text-align: center; font-size: 0.7rem; color: #999; margin-top: 5px; }

        /* ESTADO MINIMIZADO (Clase que activaremos con JS) */
        .ticket.minimized .ticket-list { display: none; }
        .ticket.minimized .ticket-content { padding-top: 5px; }
        .ticket.minimized .ticket-header { background: #e5e7eb; }
    </style>
</head>
<body>

    <div id="loading">
        <h2>üîÑ Cargando Carta...</h2>
        <p>Conectando con Google Sheets</p>
    </div>

    <header>
        <div><b>MESA:</b> <input type="number" id="mesa" class="mesa-input" placeholder="#"></div>
        <div style="font-size:0.8rem; color:green;">üü¢ v3.1</div>
    </header>

    <div class="tabs">
        <button class="tab bg-drink active" onclick="ver('bebida')">BEBIDAS</button>
        <button class="tab bg-food" onclick="ver('comida')">COMIDAS</button>
    </div>

    <div id="grid" class="grid"></div>

    <div id="ticket" class="ticket">
        <div class="ticket-header" onclick="toggleCarrito()">
            <span id="icono-toggle">üîΩ Ocultar Lista</span>
        </div>

        <div class="ticket-content">
            <div id="lista" class="ticket-list"></div>
            
            <div class="resumen-row">
                <span id="contador">0 prod.</span>
                <span id="total">0.00 ‚Ç¨</span>
            </div>
            
            <button id="btn" class="btn-send" onclick="enviar()">Cargando...</button>
            <div class="version">System v3.1 - Collapsible</div>
        </div>
    </div>

    <script>
        // ==========================================
        // ‚ö†Ô∏è PEGA AQU√ç TU URL DE GOOGLE SCRIPT ‚ö†Ô∏è
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbylLFOhzua7stXARtgdQtxrS_9UC0SJjjn0quLW5zVLzcR9_kIQTmggJt0KpMctPL5K/exec";
        // ==========================================

        let productos = [];
        let carrito = [];
        let isMinimized = false; // Estado del carrito

        window.onload = () => { fetchMenu(); };

        function fetchMenu() {
            const urlMenu = `${URL_SCRIPT}?action=obtener_menu`;
            fetch(urlMenu)
                .then(r => r.json())
                .then(d => {
                    productos = d;
                    document.getElementById('loading').style.display = 'none';
                    ver('bebida');
                    renderTicket();
                })
                .catch(e => {
                    alert("Error cargando men√∫");
                    document.getElementById('loading').innerHTML = "‚ùå Error Conexi√≥n";
                });
        }

        function ver(cat) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.bg-${cat === 'bebida' ? 'drink' : 'food'}`).classList.add('active');
            
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            const filtrados = productos.filter(x => x.cat === cat);
            if (filtrados.length === 0) grid.innerHTML = "<p style='padding:20px; grid-column:span 2; text-align:center'>Vac√≠o...</p>";

            filtrados.forEach(p => {
                const div = document.createElement('div');
                div.className = `card type-${p.cat}`;
                div.innerHTML = `<span class="p-name">${p.nombre}</span><span>${p.precio.toFixed(2)}‚Ç¨</span>`;
                div.onclick = () => { 
                    carrito.push(p); 
                    renderTicket(); 
                    // Si el carrito est√° minimizado, lo abrimos al a√±adir algo para que se vea
                    if(isMinimized) toggleCarrito();
                };
                grid.appendChild(div);
            });
        }

        // --- NUEVA FUNCI√ìN: MINIMIZAR/MAXIMIZAR ---
        function toggleCarrito() {
            const ticket = document.getElementById('ticket');
            const icono = document.getElementById('icono-toggle');
            
            isMinimized = !isMinimized; // Cambiamos estado
            
            if (isMinimized) {
                ticket.classList.add('minimized');
                icono.innerText = "üîº Ver Pedido (" + carrito.length + ")";
            } else {
                ticket.classList.remove('minimized');
                icono.innerText = "üîΩ Ocultar Lista";
            }
        }

        function renderTicket() {
            const lista = document.getElementById('lista');
            lista.innerHTML = '';
            let t = 0;
            
            // Renderizamos lista inversa (lo √∫ltimo arriba)
            const carritoInverso = [...carrito].reverse();

            carritoInverso.forEach((p, i) => {
                // Ajustamos el √≠ndice real para el borrado
                const indexReal = carrito.length - 1 - i;
                t += p.precio;
                lista.innerHTML += `<div class="ticket-item">
                    <span>${p.nombre}</span>
                    <div>${p.precio.toFixed(2)}‚Ç¨ <span class="btn-del" onclick="borrar(${indexReal})">‚úñ</span></div>
                </div>`;
            });

            document.getElementById('total').innerText = t.toFixed(2) + ' ‚Ç¨';
            document.getElementById('contador').innerText = carrito.length + ' prod.';
            
            // Actualizamos tambi√©n el texto del bot√≥n si est√° minimizado
            if(isMinimized) {
                 document.getElementById('icono-toggle').innerText = "üîº Ver Pedido (" + carrito.length + ")";
            }

            const btn = document.getElementById('btn');
            if(carrito.length > 0) {
                btn.disabled = false;
                btn.innerText = `ENVIAR (${t.toFixed(2)}‚Ç¨) üöÄ`;
            } else {
                btn.disabled = true;
                btn.innerText = "Selecciona productos...";
            }
        }

        function borrar(i) { carrito.splice(i, 1); renderTicket(); }

        function enviar() {
            const mesa = document.getElementById('mesa').value;
            if(!mesa) { alert("‚ö†Ô∏è Falta MESA"); return; }
            const btn = document.getElementById('btn');
            btn.innerText = "Enviando..."; btn.disabled = true;

            const datos = { mesa: mesa, carrito: carrito };
            const payload = encodeURIComponent(JSON.stringify(datos));
            const urlFinal = `${URL_SCRIPT}?datos=${payload}`;

            fetch(urlFinal, { method: 'GET', mode: 'no-cors' })
            .then(() => {
                alert(`‚úÖ Pedido Mesa ${mesa} OK`);
                carrito = [];
                renderTicket();
                // Minimizamos el carrito al enviar para limpiar pantalla
                if(!isMinimized) toggleCarrito();
            })
            .catch(e => alert("Error env√≠o"))
            .finally(() => { if(carrito.length>0) btn.disabled=false; renderTicket(); });
        }
    </script>
</body>
</html>
