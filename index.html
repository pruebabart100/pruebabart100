<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TPV Bar - v3.2 (Grouped Items)</title>
    
    <style>
        :root { --primary: #2563eb; --food: #ea580c; --drink: #059669; --bg: #f3f4f6; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background-color: var(--bg); padding-bottom: 250px; }

        /* LOADING */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index: 2000; display:flex; justify-content:center; align-items:center; flex-direction:column; }

        /* HEADER */
        header { background: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .mesa-input { font-size: 1.3rem; width: 60px; text-align: center; padding: 5px; border: 2px solid var(--primary); border-radius: 8px; font-weight: bold; }

        /* TABS */
        .tabs { display: flex; gap: 10px; padding: 10px; }
        .tab { flex: 1; padding: 15px; border: none; border-radius: 8px; color: white; font-weight: bold; font-size: 1rem; opacity: 0.5; cursor: pointer; }
        .tab.active { opacity: 1; transform: scale(1.02); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .bg-drink { background-color: var(--drink); }
        .bg-food { background-color: var(--food); }

        /* GRID */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; }
        .card { background: white; padding: 20px 10px; border-radius: 10px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; border-bottom: 4px solid transparent; }
        .card:active { transform: scale(0.95); background: #e5e7eb; }
        .card.type-bebida { border-bottom-color: var(--drink); }
        .card.type-comida { border-bottom-color: var(--food); }
        .p-name { display: block; font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }

        /* TICKET FLOTANTE */
        .ticket { 
            position: fixed; bottom: 0; left: 0; width: 100%; background: white; 
            border-top-left-radius: 20px; border-top-right-radius: 20px; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2); z-index: 900;
            transition: transform 0.3s ease;
        }
        .ticket-header {
            width: 100%; padding: 10px; text-align: center; cursor: pointer;
            background: #f9fafb; border-top-left-radius: 20px; border-top-right-radius: 20px;
            border-bottom: 1px solid #eee; color: #666; font-size: 1.2rem;
        }
        .ticket-content { padding: 15px; }
        .ticket-list { max-height: 25vh; overflow-y: auto; margin-bottom: 10px; font-size: 0.9rem; transition: max-height 0.3s ease; }
        
        /* ITEM DEL TICKET (DiseÃ±o mejorado para cantidades) */
        .ticket-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dotted #ccc; }
        .item-left { display: flex; align-items: center; gap: 8px; }
        .qty-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .btn-controls { display: flex; gap: 10px; align-items: center; }
        .btn-mini { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ccc; background: white; font-weight: bold; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .btn-mini.red { color: red; border-color: #fca5a5; }

        .resumen-row { display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold; font-size: 1.1rem; }
        .btn-send { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        .btn-send:disabled { background: #ccc; }
        
        .version { text-align: center; font-size: 0.7rem; color: #999; margin-top: 5px; }

        /* ESTADO MINIMIZADO */
        .ticket.minimized .ticket-list { display: none; }
        .ticket.minimized .ticket-content { padding-top: 5px; }
        .ticket.minimized .ticket-header { background: #e5e7eb; }
    </style>
</head>
<body>

    <div id="loading">
        <h2>ðŸ”„ Cargando Carta...</h2>
        <p>Conectando con Google Sheets</p>
    </div>

    <header>
        <div><b>MESA:</b> <input type="number" id="mesa" class="mesa-input" placeholder="#"></div>
        <div style="font-size:0.8rem; color:green;">ðŸŸ¢ v3.2</div>
    </header>

    <div class="tabs">
        <button class="tab bg-drink active" onclick="ver('bebida')">BEBIDAS</button>
        <button class="tab bg-food" onclick="ver('comida')">COMIDAS</button>
    </div>

    <div id="grid" class="grid"></div>

    <div id="ticket" class="ticket">
        <div class="ticket-header" onclick="toggleCarrito()">
            <span id="icono-toggle">ðŸ”½ Ocultar Lista</span>
        </div>

        <div class="ticket-content">
            <div id="lista" class="ticket-list"></div>
            
            <div class="resumen-row">
                <span id="contador">0 prod.</span>
                <span id="total">0.00 â‚¬</span>
            </div>
            
            <button id="btn" class="btn-send" onclick="enviar()">Cargando...</button>
            <div class="version">System v3.2 - Grouped Items</div>
        </div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ PEGA AQUÃ TU URL DE GOOGLE SCRIPT âš ï¸
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyTc58feYyYDE0w0gOgKMgQQAsUIe37i7vLpA-hiudZr2R2j_nXigVl0StoAsEo5mRA/exec";
        // ==========================================

        let productos = [];
        let carrito = []; // Ahora guardarÃ¡ objetos { ...producto, cantidad: X }
        let isMinimized = false;

        window.onload = () => { fetchMenu(); };

        function fetchMenu() {
            const urlMenu = `${URL_SCRIPT}?action=obtener_menu`;
            fetch(urlMenu)
                .then(r => r.json())
                .then(d => {
                    productos = d;
                    document.getElementById('loading').style.display = 'none';
                    ver('bebida');
                    renderTicket();
                })
                .catch(e => {
                    alert("Error cargando menÃº");
                    document.getElementById('loading').innerHTML = "âŒ Error ConexiÃ³n";
                });
        }

        function ver(cat) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.bg-${cat === 'bebida' ? 'drink' : 'food'}`).classList.add('active');
            
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            const filtrados = productos.filter(x => x.cat === cat);
            if (filtrados.length === 0) grid.innerHTML = "<p style='padding:20px; grid-column:span 2; text-align:center'>VacÃ­o...</p>";

            filtrados.forEach(p => {
                const div = document.createElement('div');
                div.className = `card type-${p.cat}`;
                div.innerHTML = `<span class="p-name">${p.nombre}</span><span>${p.precio.toFixed(2)}â‚¬</span>`;
                // Llama a la nueva funciÃ³n de agregar
                div.onclick = () => { 
                    agregarAlCarrito(p); 
                    if(isMinimized) toggleCarrito(); 
                };
                grid.appendChild(div);
            });
        }

        // --- LÃ“GICA DE AGRUPACIÃ“N ---
        function agregarAlCarrito(productoNuevo) {
            // Buscamos si ya existe un producto con el mismo nombre en el carrito
            const existente = carrito.find(item => item.nombre === productoNuevo.nombre);

            if (existente) {
                // Si existe, sumamos 1 a la cantidad
                existente.cantidad++;
            } else {
                // Si no existe, creamos una copia y le ponemos cantidad 1
                // Usamos spread operator (...) para copiar las propiedades
                carrito.push({ ...productoNuevo, cantidad: 1 });
            }
            renderTicket();
        }

        function restarDelCarrito(index) {
            // Si hay mÃ¡s de 1, restamos. Si hay 1, borramos.
            if (carrito[index].cantidad > 1) {
                carrito[index].cantidad--;
            } else {
                carrito.splice(index, 1);
            }
            renderTicket();
        }

        function toggleCarrito() {
            const ticket = document.getElementById('ticket');
            const icono = document.getElementById('icono-toggle');
            isMinimized = !isMinimized;
            
            if (isMinimized) {
                ticket.classList.add('minimized');
                icono.innerText = `ðŸ”¼ Ver Pedido (${obtenerTotalItems()})`;
            } else {
                ticket.classList.remove('minimized');
                icono.innerText = "ðŸ”½ Ocultar Lista";
            }
        }

        function obtenerTotalItems() {
            // Suma todas las cantidades de todos los productos
            return carrito.reduce((acc, item) => acc + item.cantidad, 0);
        }

        function renderTicket() {
            const lista = document.getElementById('lista');
            lista.innerHTML = '';
            let precioTotal = 0;
            
            // Recorremos el carrito
            carrito.forEach((item, index) => {
                const subtotal = item.precio * item.cantidad;
                precioTotal += subtotal;

                lista.innerHTML += `
                <div class="ticket-item">
                    <div class="item-left">
                        <span class="qty-badge">x${item.cantidad}</span>
                        <span>${item.nombre}</span>
                    </div>
                    <div class="btn-controls">
                        <span>${subtotal.toFixed(2)}â‚¬</span>
                        <div class="btn-mini red" onclick="restarDelCarrito(${index})">âž–</div>
                    </div>
                </div>`;
            });

            document.getElementById('total').innerText = precioTotal.toFixed(2) + ' â‚¬';
            const totalItems = obtenerTotalItems();
            document.getElementById('contador').innerText = totalItems + ' items';
            
            if(isMinimized) {
                 document.getElementById('icono-toggle').innerText = `ðŸ”¼ Ver Pedido (${totalItems})`;
            }

            const btn = document.getElementById('btn');
            if(carrito.length > 0) {
                btn.disabled = false;
                btn.innerText = `ENVIAR (${precioTotal.toFixed(2)}â‚¬) ðŸš€`;
            } else {
                btn.disabled = true;
                btn.innerText = "Selecciona productos...";
            }
        }

        function enviar() {
            const mesa = document.getElementById('mesa').value;
            if(!mesa) { alert("âš ï¸ Falta MESA"); return; }
            const btn = document.getElementById('btn');
            btn.innerText = "Enviando..."; btn.disabled = true;

            const datos = { mesa: mesa, carrito: carrito };
            const payload = encodeURIComponent(JSON.stringify(datos));
            const urlFinal = `${URL_SCRIPT}?datos=${payload}`;

            fetch(urlFinal, { method: 'GET', mode: 'no-cors' })
            .then(() => {
                alert(`âœ… Pedido Mesa ${mesa} OK`);
                carrito = [];
                renderTicket();
                if(!isMinimized) toggleCarrito();
            })
            .catch(e => alert("Error envÃ­o"))
            .finally(() => { 
                if(carrito.length > 0) btn.disabled=false; 
                renderTicket(); 
            });
        }
    </script>
</body>
</html>
