<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDS - Pantalla Cocina</title>
    <style>
        :root { --pendiente: #ef4444; --proceso: #f59e0b; --listo: #10b981; --bg: #1f2937; --card: #374151; --text: #f3f4f6; }
        * { box-sizing: border-box; font-family: sans-serif; margin:0; padding:0; }
        body { background: var(--bg); color: var(--text); padding: 10px; }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #111827; margin-bottom: 20px; border-radius: 8px; }
        .reloj { font-size: 1.2rem; font-weight: bold; }
        .status-ind { width: 15px; height: 15px; background: red; border-radius: 50%; display: inline-block; }
        .status-ind.online { background: #10b981; }

        /* Grid de Comandas */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }

        /* Tarjeta de Pedido */
        .card { 
            background: var(--card); border-radius: 12px; padding: 15px; 
            border-left: 10px solid var(--pendiente); /* Color por defecto */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }

        .card-header { display: flex; justify-content: space-between; font-size: 1.4rem; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #4b5563; padding-bottom: 5px; }
        .card-body { font-size: 1.2rem; margin-bottom: 15px; }
        .qty { background: #fff; color: #000; padding: 2px 8px; border-radius: 4px; font-weight: bold; margin-right: 10px; }
        
        /* Botones de Acci√≥n */
        .actions { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; color: white; opacity: 0.4; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.8; }
        
        /* Estados Activos */
        .card[data-status="Pendiente"] { border-left-color: var(--pendiente); }
        .card[data-status="Pendiente"] .btn-pend { opacity: 1; background: var(--pendiente); }
        
        .card[data-status="En Preparaci√≥n"] { border-left-color: var(--proceso); }
        .card[data-status="En Preparaci√≥n"] .btn-proc { opacity: 1; background: var(--proceso); }

        /* Animaci√≥n de entrada */
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .new-item { animation: slideIn 0.3s ease-out; }

    </style>
</head>
<body>

    <header>
        <h1>üë®‚Äçüç≥ Cocina</h1>
        <div style="display:flex; gap:10px; align-items:center;">
            <span id="last-update">Sincronizando...</span>
            <div id="connection" class="status-ind"></div>
        </div>
    </header>

    <div id="tablero" class="grid">
        </div>

    <script>
        // ‚ö†Ô∏è PEGA AQU√ç TU URL DEL SCRIPT
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhOCH0BAveO6-tlBGmEhccBmwxMfLcWJcv_heeVa0ccqCsjjkqE28CJ15GxDx1OxE7/exec";

        let pedidosLocales = []; // Memoria local para comparar
        let primeraCarga = true;

        // Iniciar
        window.onload = () => {
            cargarPedidos();
            setInterval(cargarPedidos, 15000); // Recargar cada 15 segundos
            setInterval(actualizarReloj, 1000);
        };

        function cargarPedidos() {
            document.getElementById('connection').style.opacity = "0.5";
            
            fetch(`${SCRIPT_URL}?action=obtener_cocina`)
                .then(r => r.json())
                .then(datos => {
                    document.getElementById('connection').classList.add('online');
                    document.getElementById('connection').style.opacity = "1";
                    renderizarTablero(datos);
                    document.getElementById('last-update').innerText = new Date().toLocaleTimeString();
                })
                .catch(e => {
                    console.error(e);
                    document.getElementById('connection').classList.remove('online');
                });
        }

        function renderizarTablero(datosNuevos) {
            const tablero = document.getElementById('tablero');
            
            // ESTRATEGIA: No borramos todo el tablero para no marear al chef.
            // Solo a√±adimos lo nuevo o actualizamos lo existente.
            
            datosNuevos.forEach(pedido => {
                // Buscamos si ya existe la tarjeta en el HTML
                let tarjeta = document.getElementById(`fila-${pedido.fila}`);

                if (!tarjeta) {
                    // SI ES NUEVO: Lo creamos
                    const html = crearTarjetaHTML(pedido);
                    tablero.insertAdjacentHTML('beforeend', html);
                } else {
                    // SI YA EXISTE: Verificamos si alguien cambi√≥ el estado externamente
                    // Solo actualizamos si el estado del servidor es diferente al visual
                    const estadoVisual = tarjeta.getAttribute('data-status');
                    if (estadoVisual !== pedido.estado) {
                         // Actualizamos visualmente solo si ha cambiado
                         actualizarEstilosTarjeta(tarjeta, pedido.estado);
                    }
                }
            });

            // LIMPIEZA: Si hay tarjetas en pantalla que ya no vienen del servidor (porque se marcaron como "Listo"), las borramos.
            const tarjetasEnPantalla = document.querySelectorAll('.card');
            tarjetasEnPantalla.forEach(t => {
                const idFila = parseInt(t.id.replace('fila-', ''));
                const sigueExistiendo = datosNuevos.find(d => d.fila === idFila);
                if (!sigueExistiendo) {
                    t.remove(); // Se fue de la lista (Estado Listo)
                }
            });
        }

        function crearTarjetaHTML(p) {
            // Extraer solo la hora HH:MM
            const hora = new Date(p.hora).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            return `
            <div id="fila-${p.fila}" class="card new-item" data-status="${p.estado}">
                <div class="card-header">
                    <span>Mesa ${p.mesa}</span>
                    <span style="font-size:1rem; opacity:0.7">${hora}</span>
                </div>
                <div class="card-body">
                    <span class="qty">${p.cant}</span> ${p.prod}
                </div>
                <div class="actions">
                    <button class="btn btn-pend" onclick="cambiarEstado(${p.fila}, 'Pendiente')">‚è≥ Pend.</button>
                    <button class="btn btn-proc" onclick="cambiarEstado(${p.fila}, 'En Preparaci√≥n')">üî• Cocina</button>
                    <button class="btn btn-listo" style="background:var(--listo); opacity:0.4" onclick="cambiarEstado(${p.fila}, 'Listo')">‚úÖ Listo</button>
                </div>
            </div>`;
        }

        function actualizarEstilosTarjeta(tarjeta, estado) {
            tarjeta.setAttribute('data-status', estado);
        }

        // --- FUNCI√ìN CLAVE: Optimistic UI ---
        function cambiarEstado(fila, nuevoEstado) {
            const tarjeta = document.getElementById(`fila-${fila}`);
            if(!tarjeta) return;

            // 1. CAMBIO VISUAL INMEDIATO (Para que el chef no espere)
            if (nuevoEstado === 'Listo') {
                // Si est√° listo, difuminamos la tarjeta para indicar que se va a ir
                tarjeta.style.opacity = '0.5';
                tarjeta.style.transform = 'scale(0.95)';
            } else {
                actualizarEstilosTarjeta(tarjeta, nuevoEstado);
            }

            // 2. ENVIAR A GOOGLE SHEETS EN SEGUNDO PLANO
            const url = `${SCRIPT_URL}?action=actualizar_estado&fila=${fila}&estado=${encodeURIComponent(nuevoEstado)}`;
            
            fetch(url, { mode: 'no-cors' })
                .then(() => console.log(`Fila ${fila} actualizada a ${nuevoEstado}`))
                .catch(e => {
                    alert("Error de conexi√≥n. El estado no se guard√≥.");
                    // Revertir cambio visual si falla (Opcional, pero recomendable)
                    tarjeta.style.opacity = '1'; 
                });
        }

        function actualizarReloj() {
            // Un simple reloj si quieres ponerlo en el header
        }
    </script>
</body>
</html>
